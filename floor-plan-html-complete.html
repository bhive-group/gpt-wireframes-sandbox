<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Floor Plan Mapping System V5</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .seat-rect { cursor: pointer; transition: all 0.2s; }
        .notification { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        // State
        const state = {
            view: 'property-list',
            selectedProperty: null,
            selectedFloor: null,
            drawingZone: false,
            editingZone: null,
            hoveredSeat: null,
            hoveredZone: null,
            isDragging: false,
            seatMappingSeats: [],
            highlightedSeat: null,
            currentMappingIndex: 0,
            properties: [
                { id: 1, name: 'BHIVE HoneyKomb Kochi', location: 'Bengaluru Urban', floors: [
                    { id: 'f1', floorName: 'Ground Floor', zones: [], seatCodeConfig: null, seatCodes: [] },
                    { id: 'f2', floorName: 'First Floor', zones: [], seatCodeConfig: null, seatCodes: [] },
                    { id: 'f3', floorName: 'Second Floor', zones: [], seatCodeConfig: null, seatCodes: [] }
                ]},
                { id: 2, name: 'BHIVE HSR Layout', location: 'Bengaluru Urban', floors: [
                    { id: 'f4', floorName: 'Ground Floor', zones: [], seatCodeConfig: null, seatCodes: [] },
                    { id: 'f5', floorName: 'First Floor', zones: [], seatCodeConfig: null, seatCodes: [] }
                ]},
                { id: 3, name: 'BHIVE Indiranagar', location: 'Bengaluru Urban', floors: [
                    { id: 'f6', floorName: 'Ground Floor', zones: [], seatCodeConfig: null, seatCodes: [] }
                ]}
            ],
            currentZone: { name: '', productType: '', subType: '', cabinCode: '', studioCode: '', selectedSeats: [] },
            zones: [],
            floorConfig: { floorName: '' },
            seatCodeConfig: { codePrefix: '', startingNumber: '' }
        };

        // Utilities
        const showNotification = (msg, type = 'success') => {
            const colors = { success: 'bg-green-50 border-green-500 text-green-900', error: 'bg-red-50 border-red-500 text-red-900', info: 'bg-blue-50 border-blue-500 text-blue-900' };
            const icons = { success: '‚úì', error: '‚úï', info: '‚Ñπ' };
            const n = document.createElement('div');
            n.className = `notification fixed top-4 right-4 z-50 ${colors[type]} border-l-4 rounded-lg shadow-lg p-4`;
            n.innerHTML = `<div class="flex items-center gap-3"><span class="text-xl">${icons[type]}</span><p class="font-medium">${msg}</p></div>`;
            document.body.appendChild(n);
            setTimeout(() => n.remove(), 3000);
        };

        const needsSeatCode = () => state.zones.some(z => z.productType === 'coworking' && (z.subType === 'dedicated_desk' || z.subType === 'floating_zone'));
        const isSeatCodeComplete = () => state.seatCodeConfig.codePrefix && state.seatCodeConfig.startingNumber;
        const allMapped = () => state.seatMappingSeats.length > 0 && state.seatMappingSeats.every(s => s.code);
        const isSeatSelected = (id) => state.currentZone.selectedSeats.includes(id);
        
        const getZoneColor = (z) => {
            const c = { dedicated_desk: '#FCD34D', floating_zone: '#FB923C', cabin: '#EF4444', deluxe_cabin: '#3B82F6', managed_office: '#A855F7' };
            return c[z.subType] || c[z.productType] || '#fef3c7';
        };

        const toggleSeat = (id) => {
            if (isSeatSelected(id)) state.currentZone.selectedSeats = state.currentZone.selectedSeats.filter(s => s !== id);
            else state.currentZone.selectedSeats.push(id);
        };

        // Seat Grid
        const genGrid = (type = 'zone') => {
            let svg = '';
            for (let r = 0; r < 20; r++) {
                for (let c = 0; c < 10; c++) {
                    const y = 80 + r * 40, x = 80 + c * 65, id = `seat-${r}-${c}`;
                    if (y >= 880) continue;
                    let fill = 'white', stroke = '#d1d5db', sw = '2', cur = 'default';
                    const sel = isSeatSelected(id), hov = state.hoveredSeat === id;
                    const zone = state.zones.find(z => z.selectedSeats?.includes(id));
                    const zHov = state.hoveredZone && zone?.id === state.hoveredZone;
                    const code = state.seatMappingSeats.find(s => s.seatId === id);
                    const hl = state.highlightedSeat === id;

                    if (type === 'zone') {
                        if (sel) { fill = '#86efac'; stroke = '#16a34a'; sw = '3'; }
                        else if (zone) { fill = getZoneColor(zone); stroke = zHov ? '#1E40AF' : '#f59e0b'; sw = zHov ? '3' : '2'; cur = 'pointer'; }
                        else if (hov && state.drawingZone) { fill = '#f3f4f6'; stroke = '#6b7280'; }
                    } else if (type === 'seat') {
                        if (code) {
                            if (code.code) { fill = hl ? '#3B82F6' : '#10B981'; stroke = hl ? '#1E40AF' : '#059669'; cur = 'pointer'; }
                            else { fill = hl ? '#FCD34D' : getZoneColor(zone); stroke = '#f59e0b'; cur = 'pointer'; }
                            sw = hl ? '4' : '2';
                        }
                    } else if (type === 'view') {
                        if (zone) { fill = getZoneColor(zone); stroke = zHov ? '#1E40AF' : '#f59e0b'; sw = zHov ? '3' : '2'; }
                    }

                    svg += `<rect class="seat-rect" x="${x}" y="${y}" width="50" height="30" fill="${fill}" stroke="${stroke}" stroke-width="${sw}" style="cursor:${cur}" data-id="${id}"/>`;
                    if (code?.code && (type === 'seat' || type === 'view')) {
                        const tf = hl ? '#FFF' : '#000', cf = hl ? '#FFF' : '#333';
                        svg += `<text x="${x+25}" y="${y+14}" text-anchor="middle" font-size="8" fill="${tf}" font-weight="bold" style="pointer-events:none">#${code.selectionOrder}</text>`;
                        svg += `<text x="${x+25}" y="${y+24}" text-anchor="middle" font-size="7" fill="${cf}" style="pointer-events:none">${code.code}</text>`;
                    }
                }
            }
            return svg;
        };

        // Actions
        const selectProperty = (id) => { state.selectedProperty = state.properties.find(p => p.id === id); state.view = 'floor-list'; render(); };
        const backToProps = () => { state.view = 'property-list'; state.selectedProperty = null; render(); };
        const backToFloors = () => { resetFloor(); state.view = 'floor-list'; render(); };
        const backToUpload = () => { state.view = 'floor-upload'; render(); };
        const backToZones = () => { state.view = 'zone-mapping'; render(); setTimeout(setupEvents, 100); };

        const resetFloor = () => {
            state.floorConfig = { floorName: '' }; state.zones = []; state.seatCodeConfig = { codePrefix: '', startingNumber: '' };
            state.seatMappingSeats = []; state.highlightedSeat = null; state.currentMappingIndex = 0; state.selectedFloor = null;
        };

        const loadFloor = (f) => {
            state.selectedFloor = f; state.floorConfig = { floorName: f.floorName }; state.zones = f.zones || [];
            state.seatCodeConfig = f.seatCodeConfig || { codePrefix: '', startingNumber: '' };
            if (f.seatCodes?.length > 0) { state.seatMappingSeats = f.seatCodes; state.currentMappingIndex = f.seatCodes.filter(s => s.code).length; }
        };

        const configFloor = (fid, isCfg) => {
            const f = state.selectedProperty.floors.find(fl => fl.id === fid);
            if (isCfg) loadFloor(f); else { resetFloor(); state.selectedFloor = f; state.floorConfig = { floorName: f.floorName }; }
            state.view = 'floor-upload'; render();
        };

        const viewLayout = (fid) => {
            const f = state.selectedProperty.floors.find(fl => fl.id === fid);
            loadFloor(f); state.view = 'layout-view'; render();
        };

        const goZones = () => { state.view = 'zone-mapping'; render(); setTimeout(setupEvents, 100); };
        const goSeats = () => {
            const s = [];
            state.zones.forEach(z => {
                if (z.productType === 'coworking' && (z.subType === 'dedicated_desk' || z.subType === 'floating_zone')) {
                    z.selectedSeats.forEach(sid => s.push({ seatId: sid, zoneId: z.id, zoneName: z.name, code: null, selectionOrder: null }));
                }
            });
            state.seatMappingSeats = s; state.currentMappingIndex = 0; state.view = 'seat-mapping'; render(); setTimeout(setupEvents, 100);
        };

        const startDraw = () => { state.drawingZone = true; render(); setTimeout(setupEvents, 100); };
        const clearSel = () => { state.currentZone.selectedSeats = []; render(); setTimeout(setupEvents, 100); };
        const cancelZone = () => {
            state.drawingZone = false; state.editingZone = null;
            state.currentZone = { name: '', productType: '', subType: '', cabinCode: '', studioCode: '', selectedSeats: [] };
            render(); setTimeout(setupEvents, 100);
        };

        const saveZone = () => {
            const n = document.getElementById('zoneName')?.value || '';
            const pt = document.getElementById('productType')?.value || '';
            const st = document.getElementById('subType')?.value || '';
            const cc = document.getElementById('cabinCode')?.value || '';
            const sc = document.getElementById('studioCode')?.value || '';
            state.currentZone = { ...state.currentZone, name: n, productType: pt, subType: st, cabinCode: cc, studioCode: sc };

            if (!state.currentZone.name || !state.currentZone.productType) return showNotification('Fill required fields', 'error');
            if (state.currentZone.productType === 'coworking' && !state.currentZone.subType) return showNotification('Select Sub Type', 'error');
            if ((state.currentZone.subType === 'cabin' || state.currentZone.subType === 'deluxe_cabin') && !state.currentZone.cabinCode) return showNotification('Cabin Code required', 'error');
            if (state.currentZone.productType === 'managed_office' && !state.currentZone.studioCode) return showNotification('Studio Code required', 'error');
            if (state.currentZone.selectedSeats.length === 0) return showNotification('Select at least one seat', 'error');

            if (state.editingZone) {
                state.zones = state.zones.map(z => z.id === state.editingZone ? {...state.currentZone, id: state.editingZone, seats: state.currentZone.selectedSeats.length} : z);
                state.editingZone = null; showNotification('Zone updated!', 'success');
            } else {
                state.zones.push({...state.currentZone, id: Date.now(), seats: state.currentZone.selectedSeats.length}); showNotification('Zone created!', 'success');
            }
            state.drawingZone = false; state.currentZone = { name: '', productType: '', subType: '', cabinCode: '', studioCode: '', selectedSeats: [] };
            render(); setTimeout(setupEvents, 100);
        };

        const editZone = (id) => {
            if (!state.drawingZone) {
                const z = state.zones.find(zn => zn.id === id);
                state.editingZone = z.id; state.currentZone = {...z}; state.drawingZone = true;
                showNotification(`Editing: ${z.name}`, 'info'); render(); setTimeout(setupEvents, 100);
            }
        };

        const delZone = (id) => {
            if (confirm('Delete zone?')) { state.zones = state.zones.filter(z => z.id !== id); showNotification('Zone deleted', 'success'); render(); setTimeout(setupEvents, 100); }
        };

        const hoverZ = (id) => { if (!state.drawingZone) { state.hoveredZone = id; render(); setTimeout(setupEvents, 100); } };
        const unhoverZ = () => { state.hoveredZone = null; render(); setTimeout(setupEvents, 100); };

        const saveFloor = () => {
            if (state.zones.length === 0) return showNotification('Create at least one zone', 'error');
            if (needsSeatCode() && !allMapped()) return showNotification('Complete seat mapping', 'error');

            const uf = { ...state.selectedFloor, zones: [...state.zones], seatCodeConfig: needsSeatCode() ? {...state.seatCodeConfig} : null,
                seatCodes: needsSeatCode() ? state.seatMappingSeats.filter(s => s.code) : [], updatedAt: new Date().toISOString() };

            state.properties = state.properties.map(p => {
                if (p.id === state.selectedProperty.id) {
                    return { ...p, floors: p.floors.map(f => f.id === state.selectedFloor.id ? uf : f) };
                }
                return p;
            });
            showNotification('Floor saved! üéâ', 'success');
            setTimeout(() => { resetFloor(); state.view = 'floor-list'; render(); }, 1500);
        };

        const updateCode = (f, v) => { state.seatCodeConfig[f] = v; render(); setTimeout(setupEvents, 100); };

        const mapSeat = (id) => {
            if (!isSeatCodeComplete()) return showNotification('Enter prefix and number', 'error');
            const idx = state.seatMappingSeats.findIndex(s => s.seatId === id);
            if (idx === -1) return;
            const s = state.seatMappingSeats[idx];
            if (s.code) { state.highlightedSeat = id; render(); return; }
            const nc = `${state.seatCodeConfig.codePrefix}-${parseInt(state.seatCodeConfig.startingNumber) + state.currentMappingIndex}`;
            state.seatMappingSeats[idx] = { ...s, code: nc, selectionOrder: state.currentMappingIndex + 1 };
            state.currentMappingIndex++; state.highlightedSeat = id; showNotification(`Assigned ${nc}`, 'success');
            render(); setTimeout(setupEvents, 100);
        };

        const undoMap = () => {
            if (state.currentMappingIndex === 0) return showNotification('Nothing to undo', 'info');
            const last = state.seatMappingSeats.filter(s => s.selectionOrder).sort((a,b) => b.selectionOrder - a.selectionOrder)[0];
            if (last) {
                state.seatMappingSeats = state.seatMappingSeats.map(s => s.seatId === last.seatId ? {...s, code: null, selectionOrder: null} : s);
                state.currentMappingIndex--; state.highlightedSeat = null; showNotification('Mapping removed', 'info');
                render(); setTimeout(setupEvents, 100);
            }
        };

        const resetMap = () => {
            state.seatMappingSeats = state.seatMappingSeats.map(s => ({...s, code: null, selectionOrder: null}));
            state.currentMappingIndex = 0; state.highlightedSeat = null; showNotification('Mappings cleared', 'info');
            render(); setTimeout(setupEvents, 100);
        };

        const hlSeat = (id) => { state.highlightedSeat = id; render(); setTimeout(setupEvents, 100); };
        const unhlSeat = () => { state.highlightedSeat = null; render(); setTimeout(setupEvents, 100); };

        // Event Setup
        const setupEvents = () => {
            const svg = document.querySelector('#grid svg');
            if (!svg) return;
            const seats = svg.querySelectorAll('.seat-rect');
            seats.forEach(s => {
                const id = s.getAttribute('data-id');
                s.onmousedown = () => {
                    if (state.view === 'zone-mapping') {
                        if (!state.drawingZone) {
                            const cz = state.zones.find(z => z.selectedSeats?.includes(id));
                            if (cz) return editZone(cz.id);
                        }
                        if (state.drawingZone) { state.isDragging = true; toggleSeat(id); render(); setTimeout(setupEvents, 100); }
                    }
                };
                s.onmouseenter = () => {
                    state.hoveredSeat = id;
                    if (state.isDragging && state.drawingZone && !isSeatSelected(id)) { toggleSeat(id); render(); setTimeout(setupEvents, 100); }
                };
                s.onclick = () => { if (state.view === 'seat-mapping' && isSeatCodeComplete()) mapSeat(id); };
            });
            svg.onmouseup = () => state.isDragging = false;
            svg.onmouseleave = () => state.isDragging = false;

            const pt = document.getElementById('productType');
            if (pt) pt.onchange = () => { state.currentZone.productType = pt.value; state.currentZone.subType = ''; render(); setTimeout(setupEvents, 100); };
            const st = document.getElementById('subType');
            if (st) st.onchange = () => { state.currentZone.subType = st.value; render(); setTimeout(setupEvents, 100); };
        };

        // Renders
        const renderProps = () => `
            <div class="h-screen flex bg-gray-50">
                <div class="w-64 bg-white border-r p-4">
                    <div class="flex items-center gap-2 mb-6">
                        <div class="w-8 h-8 bg-orange-500 rounded flex items-center justify-center"><span class="text-white font-bold">B</span></div>
                        <span class="font-semibold">BHIVE WORKSPACE</span>
                    </div>
                </div>
                <div class="flex-1 p-6">
                    <h1 class="text-2xl font-semibold mb-6">Properties - Floor Plans</h1>
                    <div class="bg-white rounded-lg border shadow-sm">
                        <table class="w-full">
                            <thead class="bg-gray-50 border-b">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Property</th>
                                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Location</th>
                                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Floors</th>
                                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${state.properties.map((p, i) => `
                                    <tr class="hover:bg-blue-50 ${i > 0 ? 'border-t' : ''}">
                                        <td class="px-6 py-4 font-medium">${p.name}</td>
                                        <td class="px-6 py-4 text-gray-600">${p.location}</td>
                                        <td class="px-6 py-4 text-gray-600">${p.floors.length} floor(s)</td>
                                        <td class="px-6 py-4">
                                            <button onclick="selectProperty(${p.id})" class="text-blue-600 hover:text-blue-700 font-medium">Manage Floors ‚Üí</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;

        const renderFloors = () => {
            const p = state.properties.find(pr => pr.id === state.selectedProperty.id);
            const cfg = p.floors.filter(f => f.zones?.length > 0).length;
            const seats = p.floors.reduce((s, f) => s + (f.zones ? f.zones.reduce((z, zn) => z + zn.seats, 0) : 0), 0);
            return `
                <div class="h-screen flex bg-gray-50">
                    <div class="w-64 bg-white border-r p-4">
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-8 bg-orange-500 rounded flex items-center justify-center"><span class="text-white font-bold">B</span></div>
                            <span class="font-semibold">BHIVE WORKSPACE</span>
                        </div>
                    </div>
                    <div class="flex-1 p-8 overflow-auto">
                        <button onclick="backToProps()" class="text-gray-600 hover:text-gray-900 flex items-center text-sm mb-6 font-medium">‚Üê Back to Properties</button>
                        <div class="flex items-start justify-between mb-8">
                            <div>
                                <h1 class="text-3xl font-bold mb-2">${p.name}</h1>
                                <div class="flex items-center gap-4 text-sm text-gray-600">
                                    <span>üìç ${p.location}</span><span>üè¢ ${p.floors.length} floors</span>
                                </div>
                            </div>
                            <div class="flex gap-3">
                                <div class="bg-white rounded-lg border px-4 py-2 text-center min-w-[100px]">
                                    <p class="text-xs text-gray-500 mb-1">Configured</p>
                                    <p class="text-2xl font-bold text-green-600">${cfg}/${p.floors.length}</p>
                                </div>
                                <div class="bg-white rounded-lg border px-4 py-2 text-center min-w-[100px]">
                                    <p class="text-xs text-gray-500 mb-1">Total Seats</p>
                                    <p class="text-2xl font-bold text-gray-900">${seats}</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg border shadow-sm">
                            <div class="border-b px-6 py-4"><h2 class="text-lg font-semibold">Floor Plans</h2></div>
                            <div class="divide-y">
                                ${p.floors.map(f => {
                                    const hZ = f.zones?.length > 0, iC = hZ, tS = hZ ? f.zones.reduce((s, z) => s + z.seats, 0) : 0;
                                    return `
                                        <div class="px-6 py-5 hover:bg-gray-50">
                                            <div class="flex items-center justify-between">
                                                <div class="flex items-center gap-6 flex-1">
                                                    <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center"><span class="text-white text-2xl">üìã</span></div>
                                                    <div class="flex-1">
                                                        <div class="flex items-center gap-3 mb-1">
                                                            <h3 class="text-lg font-semibold">${f.floorName}</h3>
                                                            ${iC ? '<span class="px-2.5 py-0.5 bg-green-50 border border-green-200 rounded-full text-xs font-medium text-green-700">‚úì Configured</span>' : '<span class="px-2.5 py-0.5 bg-orange-50 border border-orange-200 rounded-full text-xs font-medium text-orange-700">‚è± Setup Required</span>'}
                                                        </div>
                                                        ${iC ? `<div class="flex items-center gap-6 text-sm text-gray-600">
                                                            <span>üìã <span class="font-medium text-gray-900">${f.zones.length}</span> zones</span>
                                                            <span>üìç <span class="font-medium text-gray-900">${tS}</span> seats</span>
                                                            ${f.seatCodes?.length > 0 ? `<span>‚úì <span class="font-medium text-gray-900">${f.seatCodes.length}</span> coded</span>` : ''}
                                                        </div>` : '<p class="text-sm text-gray-500">Configure zones and seat mappings</p>'}
                                                    </div>
                                                </div>
                                                <div class="flex items-center gap-2 ml-6">
                                                    <button onclick='configFloor("${f.id}", ${iC})' class="px-5 py-2 rounded-lg text-sm font-medium ${iC ? 'bg-white border-2 border-blue-600 text-blue-600 hover:bg-blue-50' : 'bg-blue-600 text-white hover:bg-blue-700'}">
                                                        ${iC ? '‚úèÔ∏è Configure' : '‚ûï Start Setup'}
                                                    </button>
                                                    <button onclick='viewLayout("${f.id}")' class="px-5 py-2 bg-white border-2 border-gray-300 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-50">üëÅÔ∏è View</button>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };

        const renderUpload = () => `
            <div class="h-screen flex bg-gray-50">
                <div class="w-64 bg-white border-r p-4">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 bg-orange-500 rounded flex items-center justify-center"><span class="text-white font-bold">B</span></div>
                        <span class="font-semibold">BHIVE WORKSPACE</span>
                    </div>
                </div>
                <div class="flex-1 p-6 overflow-auto">
                    <button onclick="backToFloors()" class="text-gray-600 hover:text-gray-900 flex items-center text-sm mb-4">‚Üê Back to Floors</button>
                    <h1 class="text-2xl font-semibold mb-2">Floor Configuration</h1>
                    <p class="text-sm text-gray-600 mb-6">${state.selectedProperty.name} ‚Ä¢ ${state.floorConfig.floorName}</p>
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                        <div class="flex items-start gap-3">
                            <span class="text-blue-600 text-xl">‚ÑπÔ∏è</span>
                            <div><h3 class="font-medium text-blue-900">Configuration Steps</h3>
                            <p class="text-sm text-blue-800 mt-1">1. Add zones ‚Üí 2. Configure seat codes (if needed) ‚Üí 3. Save</p></div>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg border shadow-sm p-6">
                        <h3 class="font-semibold mb-4">Configuration Progress</h3>
                        <div class="space-y-3">
                            <div class="flex items-center justify-between p-4 border rounded-lg hover:border-blue-300">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-full flex items-center justify-center ${state.zones.length > 0 ? 'bg-green-100' : 'bg-gray-100'}">
                                        <span class="text-2xl">${state.zones.length > 0 ? '‚úì' : '‚è±'}</span>
                                    </div>
                                    <div><div class="font-medium">Zones</div>
                                    <div class="text-sm text-gray-600">${state.zones.length > 0 ? `${state.zones.length} configured` : 'Not configured'}</div></div>
                                </div>
                                <button onclick="goZones()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm">${state.zones.length > 0 ? 'Edit Zones' : 'Add Zones'}</button>
                            </div>
                            ${needsSeatCode() ? `
                                <div class="flex items-center justify-between p-4 border rounded-lg hover:border-blue-300">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 rounded-full flex items-center justify-center ${allMapped() ? 'bg-green-100' : 'bg-gray-100'}">
                                            <span class="text-2xl">${allMapped() ? '‚úì' : '‚è±'}</span>
                                        </div>
                                        <div><div class="font-medium">Seat Codes</div>
                                        <div class="text-sm text-gray-600">${allMapped() ? 'Configured' : 'Configuration needed'}</div></div>
                                    </div>
                                    <button onclick="goSeats()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm">${allMapped() ? 'Edit' : 'Configure'}</button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            </div>
        `;

        const renderZones = () => `
            <div class="h-screen flex flex-col bg-gray-50">
                <div class="bg-white border-b px-6 py-4">
                    <button onclick="backToUpload()" class="text-gray-600 hover:text-gray-900 flex items-center text-sm mb-2">‚Üê Back</button>
                    <div class="flex items-center gap-4">
                        <h1 class="text-xl font-semibold">Zone Mapping</h1>
                        <span class="text-sm px-3 py-1 bg-blue-100 text-blue-700 rounded-full">${state.floorConfig.floorName}</span>
                    </div>
                </div>
                <div class="flex-1 flex overflow-hidden">
                    <div class="flex-1 bg-gray-100 p-6 overflow-auto">
                        <div class="bg-white rounded-lg border p-4">
                            <div class="flex items-center justify-between mb-4 pb-4 border-b">
                                <button onclick="clearSel()" class="px-3 py-1.5 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm">Clear Selection</button>
                                ${!state.drawingZone ? '<button onclick="startDraw()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">‚ûï Draw New Zone</button>' : `<div class="text-sm text-gray-600">Selected: <span class="font-semibold text-blue-600">${state.currentZone.selectedSeats.length}</span> seats</div>`}
                            </div>
                            <div id="grid" class="relative bg-white border-2 rounded-lg" style="height:600px">
                                <svg viewBox="0 0 800 1000" class="w-full h-full"><rect width="800" height="1000" fill="#f9fafb" stroke="#d1d5db" stroke-width="2"/>${genGrid('zone')}</svg>
                            </div>
                        </div>
                    </div>
                    <div class="w-96 bg-white border-l overflow-auto p-6">
                        <h2 class="text-lg font-semibold mb-6">Configuration</h2>
                        ${state.drawingZone ? `
                            <div class="mb-6 p-5 border-2 border-blue-500 rounded-lg bg-blue-50">
                                <h3 class="font-semibold text-blue-900 mb-4">${state.editingZone ? 'Edit Zone' : 'New Zone'}</h3>
                                <div class="space-y-4">
                                    <div><label class="block text-sm font-medium mb-1.5">Zone Name <span class="text-red-500">*</span></label>
                                    <input type="text" id="zoneName" placeholder="e.g., Zone 1" value="${state.currentZone.name}" class="w-full px-3 py-2.5 border rounded-lg"/></div>
                                    <div><label class="block text-sm font-medium mb-1.5">Product Type <span class="text-red-500">*</span></label>
                                    <select id="productType" class="w-full px-3 py-2.5 border rounded-lg">
                                        <option value="">Select</option>
                                        <option value="coworking" ${state.currentZone.productType === 'coworking' ? 'selected' : ''}>Coworking</option>
                                        <option value="managed_office" ${state.currentZone.productType === 'managed_office' ? 'selected' : ''}>Managed Office</option>
                                    </select></div>
                                    ${state.currentZone.productType === 'coworking' ? `
                                        <div><label class="block text-sm font-medium mb-1.5">Sub Type <span class="text-red-500">*</span></label>
                                        <select id="subType" class="w-full px-3 py-2.5 border rounded-lg">
                                            <option value="">Select</option>
                                            <option value="dedicated_desk" ${state.currentZone.subType === 'dedicated_desk' ? 'selected' : ''}>Dedicated Desk</option>
                                            <option value="floating_zone" ${state.currentZone.subType === 'floating_zone' ? 'selected' : ''}>Floating Zone</option>
                                            <option value="cabin" ${state.currentZone.subType === 'cabin' ? 'selected' : ''}>Cabin</option>
                                            <option value="deluxe_cabin" ${state.currentZone.subType === 'deluxe_cabin' ? 'selected' : ''}>Deluxe Cabin</option>
                                        </select></div>
                                    ` : ''}
                                    ${state.currentZone.subType === 'cabin' || state.currentZone.subType === 'deluxe_cabin' ? `
                                        <div><label class="block text-sm font-medium mb-1.5">Cabin Code <span class="text-red-500">*</span></label>
                                        <input type="text" id="cabinCode" placeholder="e.g., CAB-101" value="${state.currentZone.cabinCode}" class="w-full px-3 py-2.5 border rounded-lg"/></div>
                                    ` : ''}
                                    ${state.currentZone.productType === 'managed_office' ? `
                                        <div><label class="block text-sm font-medium mb-1.5">Studio Code <span class="text-red-500">*</span></label>
                                        <input type="text" id="studioCode" placeholder="e.g., STD-201" value="${state.currentZone.studioCode}" class="w-full px-3 py-2.5 border rounded-lg"/></div>
                                    ` : ''}
                                    <div class="flex gap-2 pt-2">
                                        <button onclick="cancelZone()" class="flex-1 px-3 py-2.5 border rounded-lg hover:bg-gray-50 text-sm">Cancel</button>
                                        <button onclick="saveZone()" class="flex-1 px-3 py-2.5 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm">${state.editingZone ? 'Update' : 'Save'}</button>
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                        <div class="space-y-3">
                            <h3 class="text-sm font-semibold text-gray-700">Zones (${state.zones.length})</h3>
                            ${state.zones.length === 0 ? '<div class="text-center py-8 text-gray-500"><div class="text-4xl mb-3">üìç</div><p class="text-sm">No zones yet</p><p class="text-xs text-gray-400 mt-1">Click "Draw New Zone"</p></div>' : `
                                ${!state.drawingZone ? '<div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-3 text-xs text-blue-800">‚ÑπÔ∏è Click any zone to edit or hover to highlight</div>' : ''}
                                ${state.zones.map(z => `
                                    <div class="border rounded-lg p-4 hover:border-blue-500 ${state.editingZone === z.id ? 'border-blue-500 bg-blue-50' : ''}" onmouseenter="hoverZ(${z.id})" onmouseleave="unhoverZ()" onclick="editZone(${z.id})">
                                        <div class="flex items-start justify-between mb-3">
                                            <div>
                                                <div class="font-medium">${z.name}</div>
                                                <div class="text-sm text-gray-600 capitalize">${z.productType === 'coworking' ? z.subType.replace('_', ' ') : 'Managed Office'}</div>
                                                ${z.cabinCode ? `<div class="text-xs text-gray-500 mt-1">Code: ${z.cabinCode}</div>` : ''}
                                                ${z.studioCode ? `<div class="text-xs text-gray-500 mt-1">Code: ${z.studioCode}</div>` : ''}
                                            </div>
                                            <div class="flex gap-1">
                                                <button onclick="event.stopPropagation();editZone(${z.id})" class="p-1.5 text-blue-600 hover:bg-blue-50 rounded">‚úèÔ∏è</button>
                                                <button onclick="event.stopPropagation();delZone(${z.id})" class="p-1.5 text-red-600 hover:bg-red-50 rounded">üóëÔ∏è</button>
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <div class="w-full h-3 rounded" style="background:${getZoneColor(z)}"></div>
                                            <div class="text-sm text-gray-600 whitespace-nowrap">${z.seats} seats</div>
                                        </div>
                                    </div>
                                `).join('')}
                            `}
                        </div>
                    </div>
                </div>
                <div class="bg-white border-t px-6 py-4 flex justify-between">
                    <button onclick="backToUpload()" class="text-gray-600 hover:text-gray-900">‚Üê Back</button>
                    <div class="flex gap-3">
                        ${state.zones.length > 0 && needsSeatCode() ? '<button onclick="goSeats()" class="px-6 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Continue ‚Üí</button>' : ''}
                        ${state.zones.length > 0 && !needsSeatCode() ? '<button onclick="saveFloor()" class="px-6 py-2.5 bg-green-600 text-white rounded-lg hover:bg-green-700">üíæ Save Floor</button>' : ''}
                    </div>
                </div>
            </div>
        `;

        const renderSeats = () => {
            const mc = state.seatMappingSeats.filter(s => s.code).length, tc = state.seatMappingSeats.length;
            return `
                <div class="h-screen flex flex-col bg-gray-50">
                    <div class="bg-white border-b px-6 py-4">
                        <button onclick="backToZones()" class="text-gray-600 flex items-center text-sm mb-2">‚Üê Back</button>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-4">
                                <h1 class="text-xl font-semibold">Seat Code Mapping</h1>
                                <span class="text-sm px-3 py-1 bg-blue-100 text-blue-700 rounded-full">${state.floorConfig.floorName}</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="text-sm font-medium text-gray-600">Progress: ${mc}/${tc}</span>
                                ${mc > 0 ? '<button onclick="undoMap()" class="px-3 py-1.5 text-sm bg-orange-50 text-orange-600 rounded-lg hover:bg-orange-100 border border-orange-200">‚Üê Undo</button><button onclick="resetMap()" class="px-3 py-1.5 text-sm bg-red-50 text-red-600 rounded-lg hover:bg-red-100 border border-red-200">Clear</button>' : ''}
                            </div>
                        </div>
                    </div>
                    <div class="flex-1 flex overflow-hidden">
                        <div class="flex-1 p-6 overflow-auto bg-gray-100">
                            <div class="bg-white rounded-lg border p-6">
                                <h3 class="font-semibold mb-4">Click Seats to Assign Codes</h3>
                                <div class="bg-yellow-50 border border-yellow-300 rounded-lg p-4 mb-4 text-sm text-yellow-900">‚ÑπÔ∏è <strong>Instructions:</strong> Enter prefix and starting number, then click seats in order</div>
                                <div id="grid" class="relative bg-white border-2 rounded-lg" style="height:600px">
                                    <svg viewBox="0 0 800 1000" class="w-full h-full"><rect width="800" height="1000" fill="#f9fafb" stroke="#d1d5db" stroke-width="2"/>${genGrid('seat')}</svg>
                                </div>
                                <div class="mt-4 flex gap-2">
                                    <div class="flex items-center gap-2"><div class="w-6 h-6 border-2 border-gray-300" style="background:#FCD34D"></div><span class="text-sm text-gray-600">Unmapped</span></div>
                                    <div class="flex items-center gap-2"><div class="w-6 h-6 border-2 border-green-600" style="background:#10B981"></div><span class="text-sm text-gray-600">Mapped</span></div>
                                    <div class="flex items-center gap-2"><div class="w-6 h-6 border-2 border-blue-600" style="background:#3B82F6"></div><span class="text-sm text-gray-600">Highlighted</span></div>
                                </div>
                            </div>
                        </div>
                        <div class="w-96 bg-white border-l overflow-auto p-6">
                            <h2 class="text-lg font-semibold mb-4">Configuration</h2>
                            <div class="bg-blue-50 border border-blue-300 rounded-lg p-4 mb-6">
                                <h3 class="font-semibold text-blue-900 mb-3">Seat Code Format</h3>
                                <div class="space-y-3">
                                    <div><label class="block text-sm font-medium mb-1.5">Code Prefix <span class="text-red-500">*</span></label>
                                    <input type="text" id="codePrefix" value="${state.seatCodeConfig.codePrefix}" placeholder="e.g., BLR-01" onchange="updateCode('codePrefix',this.value)" class="w-full px-3 py-2 border rounded-lg" ${mc > 0 ? 'disabled' : ''}/></div>
                                    <div><label class="block text-sm font-medium mb-1.5">Starting Number <span class="text-red-500">*</span></label>
                                    <input type="number" id="startingNumber" value="${state.seatCodeConfig.startingNumber}" placeholder="e.g., 1" onchange="updateCode('startingNumber',this.value)" class="w-full px-3 py-2 border rounded-lg" ${mc > 0 ? 'disabled' : ''}/></div>
                                </div>
                                ${isSeatCodeComplete() && mc === 0 ? `<div class="mt-3 p-3 bg-white border rounded-lg"><div class="text-xs text-gray-600 mb-1">Next code:</div><div class="font-mono text-sm font-semibold text-blue-600">${state.seatCodeConfig.codePrefix}-${parseInt(state.seatCodeConfig.startingNumber) + state.currentMappingIndex}</div></div>` : ''}
                            </div>
                            <div class="space-y-2">
                                <h3 class="font-semibold mb-3">Mapped Seats (${mc}/${tc})</h3>
                                ${mc === 0 ? '<div class="text-center py-8 text-gray-500"><div class="text-4xl mb-3">üìç</div><p class="text-sm">No seats mapped</p></div>' : `
                                    <div class="space-y-2 max-h-96 overflow-y-auto">
                                        ${state.seatMappingSeats.filter(s => s.code).sort((a,b) => a.selectionOrder - b.selectionOrder).map(s => `
                                            <div onmouseenter="hlSeat('${s.seatId}')" onmouseleave="unhlSeat()" class="p-3 border rounded-lg ${state.highlightedSeat === s.seatId ? 'border-blue-500 bg-blue-50 shadow-md' : 'border-gray-300 bg-white hover:border-blue-300'}">
                                                <div class="flex items-center justify-between mb-2">
                                                    <div class="flex items-center gap-2">
                                                        <div class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold ${state.highlightedSeat === s.seatId ? 'bg-blue-600 text-white' : 'bg-green-100 text-green-700'}">#${s.selectionOrder}</div>
                                                        <div class="text-xs text-gray-500">${s.zoneName}</div>
                                                    </div>
                                                </div>
                                                <div class="font-mono text-base font-semibold text-gray-900">${s.code}</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                    <div class="bg-white border-t px-6 py-4 flex justify-between">
                        <button onclick="backToZones()" class="text-gray-600">‚Üê Back</button>
                        ${allMapped() ? '<button onclick="saveFloor()" class="px-6 py-2.5 bg-green-600 text-white rounded-lg hover:bg-green-700">üíæ Save Complete Floor</button>' : ''}
                    </div>
                </div>
            `;
        };

        const renderLayout = () => {
            const hC = state.zones.length > 0;
            return `
                <div class="h-screen flex flex-col bg-gray-50">
                    <div class="bg-white border-b px-6 py-4">
                        <button onclick="backToFloors()" class="text-gray-600 hover:text-gray-900 flex items-center text-sm mb-2">‚Üê Back to Floors</button>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-4">
                                <h1 class="text-xl font-semibold">Layout View</h1>
                                <span class="text-sm px-3 py-1 bg-blue-100 text-blue-700 rounded-full">${state.floorConfig.floorName}</span>
                                <span class="text-sm px-3 py-1 bg-gray-100 text-gray-700 rounded-full">Read Only</span>
                            </div>
                            <button onclick='configFloor("${state.selectedFloor.id}", ${hC})' class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">‚úèÔ∏è ${hC ? 'Edit Configuration' : 'Start Configuration'}</button>
                        </div>
                    </div>
                    <div class="flex-1 flex overflow-hidden">
                        <div class="flex-1 bg-gray-100 p-6 overflow-auto">
                            <div class="bg-white rounded-lg border p-4">
                                <h3 class="font-semibold mb-4">Floor Layout</h3>
                                ${!hC ? '<div class="bg-yellow-50 border border-yellow-300 rounded-lg p-4 mb-4 text-sm text-yellow-900">‚ÑπÔ∏è <strong>No Configuration:</strong> Click "Start Configuration" above to begin</div>' : ''}
                                <div id="grid" class="relative bg-white border-2 rounded-lg" style="height:600px">
                                    <svg viewBox="0 0 800 1000" class="w-full h-full"><rect width="800" height="1000" fill="#f9fafb" stroke="#d1d5db" stroke-width="2"/>${genGrid('view')}</svg>
                                </div>
                                ${hC && state.zones.length > 0 ? `<div class="mt-4 flex flex-wrap gap-3">${state.zones.map(z => `<div class="flex items-center gap-2"><div class="w-6 h-6 border-2 rounded" style="background:${getZoneColor(z)};border-color:#f59e0b"></div><span class="text-sm text-gray-600">${z.name}</span></div>`).join('')}</div>` : ''}
                            </div>
                        </div>
                        <div class="w-96 bg-white border-l overflow-auto p-6">
                            <h2 class="text-lg font-semibold mb-6">${hC ? 'Zone Details' : 'Floor Information'}</h2>
                            ${!hC ? '<div class="text-center py-8"><div class="text-6xl mb-4">üìã</div><h3 class="text-lg font-semibold mb-2">No Configuration</h3><p class="text-gray-600 mb-6 text-sm">This floor hasn\'t been configured yet</p><button onclick="configFloor(\'${state.selectedFloor.id}\', false)" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">‚ûï Start Configuration</button></div>' : `
                                <div class="space-y-3">
                                    ${state.zones.map(z => `
                                        <div class="border rounded-lg p-4 hover:border-blue-500" onmouseenter="hoverZ(${z.id})" onmouseleave="unhoverZ()">
                                            <div class="mb-3">
                                                <div class="font-medium text-lg">${z.name}</div>
                                                <div class="text-sm text-gray-600 capitalize mt-1">${z.productType === 'coworking' ? z.subType.replace('_', ' ') : 'Managed Office'}</div>
                                                ${z.cabinCode ? `<div class="text-xs text-gray-500 mt-2"><span class="font-medium">Cabin Code:</span> ${z.cabinCode}</div>` : ''}
                                                ${z.studioCode ? `<div class="text-xs text-gray-500 mt-2"><span class="font-medium">Studio Code:</span> ${z.studioCode}</div>` : ''}
                                            </div>
                                            <div class="flex items-center gap-2 mb-2">
                                                <div class="flex-1 h-4 rounded" style="background:${getZoneColor(z)}"></div>
                                                <div class="text-sm text-gray-600 whitespace-nowrap font-medium">${z.seats} seats</div>
                                            </div>
                                            ${state.seatMappingSeats.filter(s => s.zoneId === z.id && s.code).length > 0 ? `
                                                <div class="mt-3 pt-3 border-t">
                                                    <div class="text-xs font-medium text-gray-700 mb-2">Seat Codes:</div>
                                                    <div class="flex flex-wrap gap-1">${state.seatMappingSeats.filter(s => s.zoneId === z.id && s.code).sort((a,b) => a.selectionOrder - b.selectionOrder).map(s => `<span class="text-xs px-2 py-1 bg-gray-100 rounded font-mono">${s.code}</span>`).join('')}</div>
                                                </div>
                                            ` : ''}
                                        </div>
                                    `).join('')}
                                </div>
                                <div class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                                    <h3 class="font-semibold text-blue-900 mb-3">Summary</h3>
                                    <div class="space-y-2 text-sm">
                                        <div class="flex justify-between"><span class="text-blue-800">Total Zones:</span><span class="font-semibold text-blue-900">${state.zones.length}</span></div>
                                        <div class="flex justify-between"><span class="text-blue-800">Total Seats:</span><span class="font-semibold text-blue-900">${state.zones.reduce((s, z) => s + z.seats, 0)}</span></div>
                                        ${state.seatMappingSeats.filter(s => s.code).length > 0 ? `<div class="flex justify-between"><span class="text-blue-800">Coded Seats:</span><span class="font-semibold text-blue-900">${state.seatMappingSeats.filter(s => s.code).length}</span></div>` : ''}
                                    </div>
                                </div>
                            `}
                        </div>
                    </div>
                </div>
            `;
        };

        // Main Render
        const render = () => {
            const views = {
                'property-list': renderProps,
                'floor-list': renderFloors,
                'floor-upload': renderUpload,
                'zone-mapping': renderZones,
                'seat-mapping': renderSeats,
                'layout-view': renderLayout
            };
            document.getElementById('app').innerHTML = views[state.view]();
            if (state.view === 'zone-mapping' || state.view === 'seat-mapping') setTimeout(setupEvents, 100);
        };

        // Initialize
        render();
    </script>
</body>
</html>